import{j as e,n as Z,o as ee,p as te,B as o,q as re,r as U,P as M,s as E,e as l,L as se,f as ne,F as ae,i as oe,t as J,v as le,I as O,w as ie,x as ce,y as de,z as ue,E as H,m as xe,b as _,G,H as K,J as N,K as he,N as ge,O as pe,Q as me,R as fe,U as je,V as ye,W as V,X as be,Y as ve}from"./mui-vendor-DKc3DNyo.js";import{a as s,u as Ce}from"./react-vendor-CMMogCvm.js";import{a as D}from"./api-CiziFmkg.js";import{u as De}from"./index-6j_amgYy.js";import{u as Q}from"./utils-2Mkw4TjN.js";import{f as X,a as Y}from"./format-h-zLgRWV.js";const q=({open:v,onClose:d,onSuccess:g,initialFiles:C=[]})=>{const{t:u}=Q(),[f,k]=s.useState(0),[i,x]=s.useState([]),[j,S]=s.useState(""),[p,y]=s.useState(!1),[T,c]=s.useState(""),[m,b]=s.useState({}),[h,F]=s.useState(!1);s.useEffect(()=>{v&&C.length>0&&(x(C),k(0))},[v,C]);const I=()=>{x([]),S(""),c(""),b({}),k(0),d()},W=r=>{if(r.target.files){const a=Array.from(r.target.files).filter(t=>t.name.endsWith(".torrent"));x(t=>[...t,...a]),c("")}},$=s.useCallback(r=>{r.preventDefault(),r.stopPropagation(),F(!0)},[]),A=s.useCallback(r=>{r.preventDefault(),r.stopPropagation(),F(!1)},[]),B=s.useCallback(r=>{r.preventDefault(),r.stopPropagation(),F(!1);const a=Array.from(r.dataTransfer.files).filter(t=>t.name.endsWith(".torrent"));if(a.length===0){c("Only .torrent files are allowed");return}x(t=>[...t,...a]),c("")},[]),P=r=>{x(a=>a.filter((t,n)=>n!==r))},z=async()=>{y(!0),c("");try{if(f===0){if(i.length===0){c("Please select at least one file"),y(!1);return}for(let r=0;r<i.length;r++){const a=i[r];try{b(t=>({...t,[a.name]:0})),await D.addTorrent(a),b(t=>({...t,[a.name]:100}))}catch(t){console.error(`Failed to upload ${a.name}:`,t),b(n=>({...n,[a.name]:-1}))}}}else{if(!j.trim()){c("Please enter a magnet link"),y(!1);return}await D.addMagnet(j.trim())}setTimeout(()=>{g(),I()},500)}catch(r){c(r instanceof Error?r.message:"Failed to add torrent")}finally{y(!1)}};return e.jsxs(Z,{open:v,onClose:I,maxWidth:"sm",fullWidth:!0,children:[e.jsx(ee,{children:u("torrent.addTorrent")}),e.jsxs(te,{children:[e.jsx(o,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(re,{value:f,onChange:(r,a)=>k(a),children:[e.jsx(U,{label:u("torrent.selectFile")}),e.jsx(U,{label:u("torrent.magnetLink")})]})}),e.jsxs(o,{sx:{pt:3},children:[f===0?e.jsxs(o,{children:[e.jsxs(M,{sx:{p:3,border:2,borderStyle:"dashed",borderColor:h?"primary.main":"divider",bgcolor:h?"action.hover":"background.paper",cursor:"pointer",transition:"all 0.2s",textAlign:"center"},onDragOver:$,onDragLeave:A,onDrop:B,onClick:()=>document.getElementById("torrent-file-input")?.click(),children:[e.jsx("input",{accept:".torrent",style:{display:"none"},id:"torrent-file-input",type:"file",multiple:!0,onChange:W}),e.jsx(E,{sx:{fontSize:48,mb:2,opacity:.6}}),e.jsx(l,{variant:"h6",gutterBottom:!0,children:u("torrent.dropFileHere")}),e.jsx(l,{variant:"body2",color:"text.secondary",children:"または クリックしてファイルを選択"}),e.jsx(l,{variant:"caption",display:"block",sx:{mt:1},children:"複数のファイルを選択できます"})]}),i.length>0&&e.jsxs(o,{sx:{mt:2},children:[e.jsxs(l,{variant:"subtitle2",gutterBottom:!0,children:["選択されたファイル (",i.length,")"]}),e.jsx(se,{dense:!0,children:i.map((r,a)=>e.jsxs(ne,{children:[e.jsx(ae,{sx:{mr:1,opacity:.6}}),e.jsx(oe,{primary:r.name,secondary:`${(r.size/1024).toFixed(1)} KB`}),m[r.name]!==void 0&&e.jsx(o,{sx:{width:100,mr:2},children:m[r.name]===-1?e.jsx(l,{variant:"caption",color:"error",children:"Failed"}):e.jsx(J,{variant:"determinate",value:m[r.name],color:m[r.name]===100?"success":"primary"})}),e.jsx(le,{children:e.jsx(O,{edge:"end",size:"small",onClick:()=>P(a),disabled:p,children:e.jsx(ie,{})})})]},`${r.name}-${a}`))})]})]}):e.jsx(ce,{fullWidth:!0,multiline:!0,rows:4,variant:"outlined",placeholder:u("torrent.pastemagnetLink"),value:j,onChange:r=>S(r.target.value)}),T&&e.jsx(de,{severity:"error",sx:{mt:2},children:T})]})]}),e.jsxs(ue,{children:[e.jsx(H,{onClick:I,children:u("common.cancel")}),e.jsx(H,{onClick:z,variant:"contained",disabled:p||(f===0?i.length===0:!j.trim()),children:p?e.jsx(e.Fragment,{children:f===0&&i.length>1?`Uploading (${Object.values(m).filter(r=>r===100).length}/${i.length})...`:"Uploading..."}):u("common.add")})]})]})},Le=()=>{const v=Ce(),{t:d}=Q(),{lastMessage:g}=De(),[C,u]=s.useState([]),[f,k]=s.useState(!0),[i,x]=s.useState(!1),[j,S]=s.useState(null),[p,y]=s.useState(null),[T,c]=s.useState(!1),[m,b]=s.useState([]);s.useEffect(()=>{h()},[]),s.useEffect(()=>{g&&(g.type==="torrents"&&g.data?u(g.data):g.type==="torrent_update"&&h())},[g]);const h=async()=>{try{const t=await D.getTorrents();u(t)}catch(t){console.error("Failed to load torrents:",t)}finally{k(!1)}},F=async t=>{try{await D.startTorrent(t),await h()}catch(n){console.error("Failed to start torrent:",n)}},I=async t=>{try{await D.stopTorrent(t),await h()}catch(n){console.error("Failed to stop torrent:",n)}},W=async t=>{if(window.confirm(d("messages.confirmDelete")))try{await D.deleteTorrent(t),await h()}catch(n){console.error("Failed to delete torrent:",n)}A()},$=(t,n)=>{S(t.currentTarget),y(n)},A=()=>{S(null),y(null)},B=s.useCallback(t=>{t.preventDefault(),t.stopPropagation(),Array.from(t.dataTransfer.items).some(L=>{if(L.kind==="file"){const R=L.getAsFile();return R&&R.name.endsWith(".torrent")}return!1})&&c(!0)},[]),P=s.useCallback(t=>{t.preventDefault(),t.stopPropagation();const n=t.currentTarget.getBoundingClientRect(),w=t.clientX,L=t.clientY;(w<=n.left||w>=n.right||L<=n.top||L>=n.bottom)&&c(!1)},[]),z=s.useCallback(t=>{t.preventDefault(),t.stopPropagation(),c(!1);const n=Array.from(t.dataTransfer.files).filter(w=>w.name.endsWith(".torrent"));n.length>0&&(b(n),x(!0))},[]),r=t=>{switch(t){case"downloading":return"primary";case"seeding":return"success";case"stopped":return"default";case"error":return"error";default:return"default"}},a=s.useCallback(()=>{x(!1),b([])},[]);return f?e.jsx(o,{display:"flex",justifyContent:"center",alignItems:"center",height:"80vh",children:e.jsx(xe,{})}):C.length===0?e.jsxs(o,{onDragOver:B,onDragLeave:P,onDrop:z,sx:{minHeight:"100vh",position:"relative"},children:[e.jsxs(o,{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"60vh",children:[e.jsx(_,{sx:{fontSize:80,mb:2,opacity:.3}}),e.jsx(l,{variant:"h5",gutterBottom:!0,children:d("torrent.noTorrents")}),e.jsx(H,{variant:"contained",startIcon:e.jsx(G,{}),onClick:()=>x(!0),sx:{mt:2},children:d("torrent.addTorrent")})]}),e.jsx(q,{open:i,onClose:a,onSuccess:h,initialFiles:m}),e.jsx(K,{open:T,sx:{position:"absolute",zIndex:9999,backgroundColor:"rgba(0, 0, 0, 0.8)"},children:e.jsxs(M,{sx:{p:6,textAlign:"center",backgroundColor:"background.paper",border:3,borderStyle:"dashed",borderColor:"primary.main"},children:[e.jsx(E,{sx:{fontSize:80,mb:2,color:"primary.main"}}),e.jsx(l,{variant:"h4",gutterBottom:!0,children:d("torrent.dropFileHere")}),e.jsx(l,{variant:"body1",color:"text.secondary",children:"複数のトレントファイルをドロップできます"})]})})]}):e.jsxs(o,{onDragOver:B,onDragLeave:P,onDrop:z,sx:{minHeight:"100vh",position:"relative"},children:[e.jsx(N,{container:!0,spacing:2,children:C.map(t=>e.jsx(N,{item:!0,xs:12,children:e.jsx(he,{children:e.jsx(ge,{children:e.jsxs(o,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsxs(o,{flex:1,onClick:()=>v(`/torrent/${t.id}`),sx:{cursor:"pointer"},children:[e.jsx(l,{variant:"h6",gutterBottom:!0,children:t.info.name}),e.jsxs(o,{display:"flex",alignItems:"center",gap:2,mb:1,children:[e.jsx(pe,{label:d(`status.${t.status}`),color:r(t.status),size:"small"}),e.jsxs(l,{variant:"body2",color:"text.secondary",children:[X(t.downloaded)," / ",X(t.info.length)]}),(t.status==="downloading"||t.status==="seeding")&&e.jsxs(e.Fragment,{children:[e.jsxs(o,{display:"flex",alignItems:"center",gap:.5,children:[e.jsx(_,{fontSize:"small"}),e.jsx(l,{variant:"body2",children:Y(t.downloadRate||0)})]}),e.jsxs(o,{display:"flex",alignItems:"center",gap:.5,children:[e.jsx(E,{fontSize:"small"}),e.jsx(l,{variant:"body2",children:Y(t.uploadRate||0)})]})]})]}),e.jsx(J,{variant:"determinate",value:t.progress,sx:{height:6,borderRadius:3}}),e.jsxs(l,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:[t.progress.toFixed(1),"%"]})]}),e.jsxs(o,{display:"flex",alignItems:"center",children:[t.status==="stopped"?e.jsx(O,{color:"primary",onClick:()=>F(t.id),children:e.jsx(me,{})}):e.jsx(O,{color:"default",onClick:()=>I(t.id),children:e.jsx(fe,{})}),e.jsx(O,{onClick:n=>$(n,t.id),children:e.jsx(je,{})})]})]})})})},t.id))}),e.jsxs(ye,{anchorEl:j,open:!!j,onClose:A,children:[e.jsx(V,{onClick:()=>p&&v(`/torrent/${p}`),children:d("common.details")}),e.jsxs(V,{onClick:()=>p&&W(p),children:[e.jsx(be,{fontSize:"small",sx:{mr:1}}),d("common.delete")]})]}),e.jsx(ve,{color:"primary","aria-label":"add",sx:{position:"fixed",bottom:16,right:16},onClick:()=>x(!0),children:e.jsx(G,{})}),e.jsx(q,{open:i,onClose:a,onSuccess:h,initialFiles:m}),e.jsx(K,{open:T,sx:{position:"absolute",zIndex:9999,backgroundColor:"rgba(0, 0, 0, 0.8)"},children:e.jsxs(M,{sx:{p:6,textAlign:"center",backgroundColor:"background.paper",border:3,borderStyle:"dashed",borderColor:"primary.main"},children:[e.jsx(E,{sx:{fontSize:80,mb:2,color:"primary.main"}}),e.jsx(l,{variant:"h4",gutterBottom:!0,children:d("torrent.dropFileHere")}),e.jsx(l,{variant:"body1",color:"text.secondary",children:"複数のトレントファイルをドロップできます"})]})})]})};export{Le as default};
